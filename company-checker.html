<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Company Risk Checker</title>
<style>
:root { --bg: #0a0a0f; --card: #12121a; --border: #222; --accent: #635bff; --green: #00d4aa; --yellow: #ffbb00; --red: #ff5252; }
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #e0e0e0; min-height: 100vh; }
.container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
h1 { font-size: 1.6rem; color: #fff; }
.subtitle { color: #666; font-size: 0.9rem; }
.header-btns { display: flex; gap: 0.5rem; }
.config-btn { background: var(--card); border: 1px solid var(--border); color: #888; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
.config-btn:hover { border-color: var(--accent); color: #fff; }
.api-status { font-size: 0.8rem; padding: 0.4rem 0.8rem; border-radius: 6px; }
.api-status.ok { background: rgba(0,212,170,0.15); color: var(--green); }
.api-status.missing { background: rgba(255,82,82,0.15); color: var(--red); }

.upload-zone { border: 2px dashed #333; border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 1.5rem; }
.upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(99,91,255,0.05); }
.upload-zone input { display: none; }
.upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
.formats span { background: #1a1a24; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin: 0 0.2rem; color: #666; }
.demo-row { text-align: center; margin-bottom: 2rem; }
.btn { background: linear-gradient(135deg, var(--accent), #4f46e5); color: #fff; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem; }
.btn:hover { filter: brightness(1.1); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--card); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent); }

.stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
@media (max-width: 800px) { .stats { grid-template-columns: repeat(3, 1fr); } }
.stat { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; }
.stat-value { font-size: 1.75rem; font-weight: 700; }
.stat-label { font-size: 0.7rem; color: #666; text-transform: uppercase; margin-top: 0.2rem; }
.stat.high .stat-value { color: var(--red); }
.stat.medium .stat-value { color: var(--yellow); }
.stat.low .stat-value { color: var(--green); }
.stat.sanctions .stat-value { color: #ff3333; }

.actions { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
.search { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.75rem; color: #fff; width: 200px; font-size: 0.9rem; }
.search:focus { outline: none; border-color: var(--accent); }
.filter-select { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; color: #fff; font-size: 0.9rem; }

table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 10px; overflow: hidden; font-size: 0.9rem; }
th { background: #1a1a24; padding: 0.75rem 1rem; text-align: left; font-size: 0.7rem; text-transform: uppercase; color: #666; font-weight: 600; }
td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(99,91,255,0.03); }
tr.expanded td { background: rgba(99,91,255,0.05); }
.company-name { font-weight: 500; color: #fff; cursor: pointer; }
.company-name:hover { color: var(--accent); }
.risk-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
.risk-badge.high { background: rgba(255,82,82,0.15); color: var(--red); }
.risk-badge.medium { background: rgba(255,187,0,0.15); color: var(--yellow); }
.risk-badge.low { background: rgba(0,212,170,0.15); color: var(--green); }
.sanctions-hit { background: rgba(255,0,0,0.2); color: #ff3333; font-weight: 600; }
.score-bar { width: 50px; height: 5px; background: #222; border-radius: 3px; display: inline-block; vertical-align: middle; margin-left: 0.5rem; }
.score-fill { height: 100%; border-radius: 3px; }
.flags { font-size: 0.8rem; color: var(--red); }
.flags-warn { color: var(--yellow); }

.detail-panel { background: #0d0d14; border-top: 1px solid var(--border); padding: 1rem; }
.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.detail-section h4 { font-size: 0.75rem; color: #666; text-transform: uppercase; margin-bottom: 0.5rem; }
.detail-section p { font-size: 0.85rem; margin-bottom: 0.25rem; }
.detail-section .value { color: #fff; }
.detail-section .hit { color: var(--red); }
.detail-section .clear { color: var(--green); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; }
.modal h2 { font-size: 1.1rem; margin-bottom: 1rem; }
.modal label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: #888; }
.modal input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem; color: #fff; margin-bottom: 1rem; font-size: 0.9rem; }
.modal input:focus { outline: none; border-color: var(--accent); }
.modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
.modal small { color: #666; font-size: 0.8rem; display: block; margin-top: -0.5rem; margin-bottom: 1rem; }
.modal a { color: var(--accent); }

.progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin: 1rem 0; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
.status-text { font-size: 0.85rem; color: #888; margin-bottom: 1rem; }

.warning-box { background: rgba(255,187,0,0.1); border: 1px solid rgba(255,187,0,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
.warning-box h3 { color: var(--yellow); font-size: 0.9rem; margin-bottom: 0.5rem; }
.warning-box p { font-size: 0.85rem; color: #888; }

.hidden { display: none !important; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Company Risk Checker</h1>
      <p class="subtitle">Consolidated Screening List &amp; Risk Assessment</p>
    </div>
    <div class="header-btns">
      <span class="api-status" id="apiStatus"></span>
      <button class="config-btn" onclick="showConfig()">‚öôÔ∏è API Settings</button>
    </div>
  </header>


  <div id="uploadSection">
    <div class="upload-zone" id="dropZone">
      <div class="upload-icon">üìÅ</div>
      <div>Drop CSV file here or click to browse</div>
      <div class="formats" style="margin-top:0.75rem"><span>.csv</span></div>
      <input type="file" id="fileInput" accept=".csv">
    </div>
    <div class="demo-row">
      <span style="color:#555">or</span>
      <button class="btn btn-secondary" onclick="loadDemo()" style="margin-left:0.75rem">Load Demo Data</button>
    </div>
  </div>

  <div id="processingSection" class="hidden">
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="status-text" id="statusText">Processing...</div>
  </div>

  <div id="resultsSection" class="hidden">
    <div class="stats">
      <div class="stat"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Total</div></div>
      <div class="stat sanctions"><div class="stat-value" id="sanctionsCount">0</div><div class="stat-label">Sanctions Hits</div></div>
      <div class="stat high"><div class="stat-value" id="highCount">0</div><div class="stat-label">High Risk</div></div>
      <div class="stat medium"><div class="stat-value" id="mediumCount">0</div><div class="stat-label">Medium</div></div>
      <div class="stat low"><div class="stat-value" id="lowCount">0</div><div class="stat-label">Low Risk</div></div>
    </div>

    <div class="actions">
      <input type="text" class="search" id="searchInput" placeholder="Search...">
      <select class="filter-select" id="riskFilter">
        <option value="all">All Risks</option>
        <option value="sanctions">Sanctions Hits</option>
        <option value="high">High Risk</option>
        <option value="medium">Medium Risk</option>
        <option value="low">Low Risk</option>
      </select>
      <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
      <button class="btn btn-secondary" onclick="reset()">New Upload</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Company</th>
          <th>Jurisdiction</th>
          <th>Score</th>
          <th>Risk</th>
          <th>Sanctions</th>
          <th>Flags</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>
</div>

<div id="configModal" class="modal-overlay hidden">
  <div class="modal">
    <h2>Settings</h2>

    <label>CORS Proxy URL</label>
    <input type="text" id="corsProxy" value="https://corsproxy.io/?">
    <small>Used to fetch CSL data. Default usually works. Alternatives: <code>https://api.allorigins.win/raw?url=</code></small>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeConfig()">Cancel</button>
      <button class="btn" onclick="saveConfig()">Save</button>
    </div>
  </div>
</div>

<script>
// ============== CONFIG ==============
let config = {
  corsProxy: localStorage.getItem('corsProxy') || 'https://corsproxy.io/?'
};

// ============== TAX HAVENS ==============
const TAX_HAVENS = new Set(['ky','vg','pa','bz','sc','ae','hk','mh','ch','li','lu','mc','je','gg','im','bm','an','bs','ai','mu','cy','mt','gi','cw','tc']);
const TAX_HAVEN_NAMES = ['cayman','virgin island','panama','belize','seychelles','marshall island','bermuda','bahamas','jersey','guernsey','liechtenstein','monaco','luxembourg','mauritius','cyprus','malta','gibraltar','curacao','turks'];

// ============== PATTERNS ==============
const SHELL_PATTERNS = [/\boffshore\b/i, /\bholdings?\s*(ltd|limited|llc|inc)?$/i, /\binternational\s*(ltd|limited|llc)?$/i, /\bglobal\s*(ventures?|trading|investments?)?\s*(ltd)?$/i, /\bventures?\s*(ltd)?$/i, /\btrading\s*(co|corp|ltd)?$/i, /\binvestments?\s*(ltd)?$/i, /\bassets?\b/i, /\btrust\b/i];
const LEGIT_INDICATORS = [/\binc\.?$/i, /\bincorporated$/i, /\bplc$/i, /\bcorporation$/i, /\bgmbh$/i, /\bag$/i, /\bsa$/i, /\bnv$/i];
const MAJOR_CORPS = ['apple','microsoft','google','alphabet','amazon','tesla','meta','nvidia','oracle','ibm','intel','cisco','adobe','salesforce','walmart','costco','target','home depot','mcdonalds','starbucks','nike','coca-cola','pepsi','johnson','pfizer','jpmorgan','bank of america','wells fargo','goldman sachs','visa','mastercard','berkshire','exxon','chevron','toyota','ford','boeing','disney','netflix','verizon'];

// ============== STATE ==============
let companies = [];
let results = [];
let expandedRow = null;

// ============== DOM ==============
const $ = id => document.getElementById(id);
const dropZone = $('dropZone');
const fileInput = $('fileInput');
const uploadSection = $('uploadSection');
const processingSection = $('processingSection');
const resultsSection = $('resultsSection');
const resultsBody = $('resultsBody');
const searchInput = $('searchInput');
const riskFilter = $('riskFilter');

// ============== INIT ==============
updateApiStatus();

function updateApiStatus() {
  const status = $('apiStatus');
  const warning = $('warningBox');
  // CSL data is public, no API key needed
  status.textContent = '‚úì Ready';
  status.className = 'api-status ok';
  warning.classList.add('hidden');
}

// ============== FILE HANDLING ==============
dropZone.onclick = () => fileInput.click();
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
dropZone.ondragleave = () => dropZone.classList.remove('dragover');
dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
fileInput.onchange = e => handleFile(e.target.files[0]);
searchInput.oninput = renderResults;
riskFilter.onchange = renderResults;

function handleFile(file) {
  if (!file?.name.endsWith('.csv')) { alert('Please upload a CSV file'); return; }
  const reader = new FileReader();
  reader.onload = e => processCSV(e.target.result);
  reader.readAsText(file);
}

function parseCSVLine(line) {
  const result = []; let current = ''; let inQuotes = false;
  for (const char of line) {
    if (char === '"') inQuotes = !inQuotes;
    else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else current += char;
  }
  result.push(current.trim());
  return result.map(s => s.replace(/^"|"$/g, ''));
}

async function processCSV(text) {
  const lines = text.trim().split('\n').filter(l => l.trim());
  if (lines.length < 2) { alert('CSV must have header and data'); return; }

  const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase());
  const nameCol = headers.findIndex(h => /company|name|entity|vendor|supplier|counterparty/.test(h));
  const jurCol = headers.findIndex(h => /jurisdiction|country|jur|state|region/.test(h));
  const addrCol = headers.findIndex(h => /address|location|registered/.test(h));

  if (nameCol === -1) { alert('Could not find company name column'); return; }

  companies = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    if (cols[nameCol]?.trim()) {
      companies.push({
        name: cols[nameCol].trim(),
        jurisdiction: jurCol !== -1 ? (cols[jurCol] || '').trim() : '',
        address: addrCol !== -1 ? (cols[addrCol] || '').trim() : ''
      });
    }
  }

  if (!companies.length) { alert('No valid companies found'); return; }

  uploadSection.classList.add('hidden');
  processingSection.classList.remove('hidden');

  await scoreAllCompanies();

  processingSection.classList.add('hidden');
  resultsSection.classList.remove('hidden');
  renderResults();
}

// ============== SCORING ==============
async function scoreAllCompanies() {
  results = [];

  // Load CSL data first
  await loadCSLData();

  for (let i = 0; i < companies.length; i++) {
    $('progressFill').style.width = ((i + 1) / companies.length * 100) + '%';
    $('statusText').textContent = `Checking ${i + 1}/${companies.length}: ${companies[i].name}`;

    const result = scoreCompany(companies[i]);
    results.push(result);

    // Small delay to keep UI responsive
    if (i % 10 === 0) await new Promise(r => setTimeout(r, 10));
  }

  results.sort((a, b) => a.score - b.score);
}

function scoreCompany(company) {
  const nameLower = company.name.toLowerCase();
  const jurLower = (company.jurisdiction || '').toLowerCase().replace(/[^a-z]/g, '');

  let score = 50;
  const flags = [];
  const details = {
    sanctions: { checked: false, hits: [], error: null },
    jurisdiction: { risk: 'unknown', country: company.jurisdiction || 'Unknown' },
    patterns: []
  };

  // 1. CSL SANCTIONS CHECK
  const cslResult = searchCSL(company.name);
  details.sanctions.checked = true;
  if (cslResult.total > 0) {
    score -= 50;
    flags.push('üö® SANCTIONS HIT');
    details.sanctions.hits = cslResult.results;
  }

  // 2. JURISDICTION RISK
  const isTaxHaven = TAX_HAVENS.has(jurLower) || TAX_HAVEN_NAMES.some(th => jurLower.includes(th) || (company.jurisdiction || '').toLowerCase().includes(th));
  if (isTaxHaven) {
    score -= 20;
    flags.push('Tax haven jurisdiction');
    details.jurisdiction.risk = 'high';
  } else if (jurLower) {
    details.jurisdiction.risk = 'normal';
  }

  // 3. NAME PATTERNS
  if (MAJOR_CORPS.some(corp => nameLower.includes(corp))) {
    score += 30;
    details.patterns.push('Major corporation');
  }

  let shellScore = SHELL_PATTERNS.filter(p => p.test(company.name)).length;
  if (shellScore >= 2) {
    score -= 15;
    flags.push('Shell company naming');
    details.patterns.push('Multiple shell indicators');
  } else if (shellScore === 1) {
    score -= 5;
    details.patterns.push('Single shell indicator');
  }

  if (LEGIT_INDICATORS.some(p => p.test(company.name))) {
    score += 5;
    details.patterns.push('Formal legal entity');
  }

  if (company.name.length < 4) {
    score -= 10;
    flags.push('Very short name');
  }

  score = Math.max(0, Math.min(100, score));

  return {
    name: company.name,
    jurisdiction: company.jurisdiction || 'Unknown',
    address: company.address,
    score,
    risk: score >= 70 ? 'low' : score >= 40 ? 'medium' : 'high',
    sanctionsHit: details.sanctions.hits.length > 0,
    flags,
    details
  };
}

// ============== CSL DATA ==============
let cslData = null;
let cslLoading = false;

async function loadCSLData() {
  if (cslData) return cslData;
  if (cslLoading) {
    // Wait for loading to complete
    while (cslLoading) await new Promise(r => setTimeout(r, 100));
    return cslData;
  }

  cslLoading = true;
  const cslUrl = 'https://data.trade.gov/downloadable_consolidated_screening_list/v1/consolidated.json';
  const proxyUrl = config.corsProxy + encodeURIComponent(cslUrl);

  console.log('Loading CSL data...');
  $('statusText').textContent = 'Loading sanctions list (first time only)...';

  try {
    const resp = await fetch(proxyUrl);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    cslData = await resp.json();
    console.log(`CSL loaded: ${cslData.results?.length || 0} entries`);
  } catch (e) {
    console.error('Failed to load CSL:', e);
    cslData = { results: [] };
  }

  cslLoading = false;
  return cslData;
}

function searchCSL(companyName) {
  if (!cslData?.results) return { total: 0, results: [] };

  const searchLower = companyName.toLowerCase();
  const matches = cslData.results.filter(entry => {
    const name = (entry.name || '').toLowerCase();
    const altNames = (entry.alt_names || []).map(n => n.toLowerCase());

    // Check exact or partial match
    if (name.includes(searchLower) || searchLower.includes(name)) return true;
    if (altNames.some(alt => alt.includes(searchLower) || searchLower.includes(alt))) return true;

    // Check words overlap for fuzzy matching
    const searchWords = searchLower.split(/\s+/).filter(w => w.length > 2);
    const nameWords = name.split(/\s+/);
    const matchCount = searchWords.filter(sw => nameWords.some(nw => nw.includes(sw) || sw.includes(nw))).length;
    return matchCount >= 2 || (matchCount >= 1 && searchWords.length <= 2);
  });

  return {
    total: matches.length,
    results: matches.slice(0, 10).map(m => ({
      name: m.name,
      source: m.source,
      type: m.type,
      programs: m.programs || [],
      country: m.country || m.addresses?.[0]?.country || 'Unknown'
    }))
  };
}

// ============== RENDER ==============
function renderResults() {
  const search = searchInput.value.toLowerCase();
  const risk = riskFilter.value;

  let filtered = results;
  if (search) filtered = filtered.filter(r => r.name.toLowerCase().includes(search) || r.jurisdiction.toLowerCase().includes(search));
  if (risk === 'sanctions') filtered = filtered.filter(r => r.sanctionsHit);
  else if (risk !== 'all') filtered = filtered.filter(r => r.risk === risk);

  $('totalCount').textContent = results.length;
  $('sanctionsCount').textContent = results.filter(r => r.sanctionsHit).length;
  $('highCount').textContent = results.filter(r => r.risk === 'high').length;
  $('mediumCount').textContent = results.filter(r => r.risk === 'medium').length;
  $('lowCount').textContent = results.filter(r => r.risk === 'low').length;

  const color = s => s >= 70 ? 'var(--green)' : s >= 40 ? 'var(--yellow)' : 'var(--red)';

  resultsBody.innerHTML = filtered.map((r, i) => `
    <tr class="${expandedRow === i ? 'expanded' : ''}" data-idx="${i}">
      <td><span class="company-name" onclick="toggleDetail(${i})">${esc(r.name)}</span></td>
      <td>${esc(r.jurisdiction)}</td>
      <td>${r.score}<span class="score-bar"><span class="score-fill" style="width:${r.score}%;background:${color(r.score)}"></span></span></td>
      <td><span class="risk-badge ${r.risk}">${r.risk}</span></td>
      <td>${r.sanctionsHit ? '<span class="risk-badge sanctions-hit">HIT</span>' : r.details.sanctions.checked ? '<span style="color:var(--green)">Clear</span>' : '<span style="color:#666">-</span>'}</td>
      <td class="flags ${r.flags.some(f => f.includes('üö®')) ? '' : 'flags-warn'}">${r.flags.length ? r.flags.join(', ') : '-'}</td>
    </tr>
    ${expandedRow === i ? renderDetailPanel(r) : ''}
  `).join('');
}

function renderDetailPanel(r) {
  const d = r.details;
  return `<tr><td colspan="6" class="detail-panel">
    <div class="detail-grid">
      <div class="detail-section">
        <h4>CSL Sanctions Check</h4>
        ${d.sanctions.error ? `<p class="value" style="color:var(--yellow)">Error: ${esc(d.sanctions.error)}</p>` :
          d.sanctions.checked ?
            (d.sanctions.hits.length ?
              d.sanctions.hits.map(h => `<p class="value hit">${esc(h.name)} <small>(${esc(h.source || 'Unknown')})</small></p>`).join('') :
              '<p class="value clear">‚úì No matches found</p>') :
          '<p class="value" style="color:#666">Not checked</p>'}
      </div>
      <div class="detail-section">
        <h4>Jurisdiction</h4>
        <p>Country: <span class="value">${esc(d.jurisdiction.country)}</span></p>
        <p>Risk: <span class="value" style="color:${d.jurisdiction.risk === 'high' ? 'var(--red)' : 'var(--green)'}">${d.jurisdiction.risk}</span></p>
      </div>
      <div class="detail-section">
        <h4>Pattern Analysis</h4>
        ${d.patterns.length ? d.patterns.map(p => `<p class="value">${esc(p)}</p>`).join('') : '<p class="value">No patterns detected</p>'}
      </div>
      <div class="detail-section">
        <h4>All Flags</h4>
        ${r.flags.length ? r.flags.map(f => `<p class="value" style="color:${f.includes('üö®') ? 'var(--red)' : 'var(--yellow)'}">${esc(f)}</p>`).join('') : '<p class="value clear">None</p>'}
      </div>
    </div>
  </td></tr>`;
}

function toggleDetail(idx) {
  expandedRow = expandedRow === idx ? null : idx;
  renderResults();
}

function esc(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// ============== EXPORT ==============
function exportCSV() {
  const rows = [['Company', 'Jurisdiction', 'Score', 'Risk Level', 'Sanctions Hit', 'Sanctions Matches', 'Flags']];
  results.forEach(r => rows.push([
    r.name,
    r.jurisdiction,
    r.score,
    r.risk.toUpperCase(),
    r.sanctionsHit ? 'YES' : 'NO',
    r.details.sanctions.hits.map(h => h.name).join('; '),
    r.flags.join('; ')
  ]));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  downloadFile(csv, 'company-risk-results.csv', 'text/csv');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// ============== UTILITIES ==============
function reset() {
  companies = []; results = []; expandedRow = null;
  resultsSection.classList.add('hidden');
  uploadSection.classList.remove('hidden');
  fileInput.value = '';
  searchInput.value = '';
  riskFilter.value = 'all';
}

function loadDemo() {
  processCSV(`company_name,jurisdiction,address
Apple Inc.,US,"One Apple Park Way, Cupertino, CA"
Microsoft Corporation,US,"One Microsoft Way, Redmond, WA"
HSBC Holdings plc,GB,"8 Canada Square, London"
Acme Offshore Holdings Ltd,KY,"PO Box 309, Grand Cayman"
Caribbean Trading Company,VG,"Tortola, British Virgin Islands"
Panama Global Investments SA,PA,"Calle 50, Panama City"
Rosoboronexport,RU,"Moscow, Russia"
Huawei Technologies,CN,"Shenzhen, China"
Korea Mining Development Trading,KP,"Pyongyang, DPRK"
Sberbank,RU,"Moscow, Russia"
Dubai International Trading FZE,AE,"Jebel Ali, Dubai"
Marshall Islands Shipping LLC,MH,"Majuro, Marshall Islands"
Swiss Holding AG,CH,"Zurich, Switzerland"
Walmart Inc,US,"Bentonville, Arkansas"
Toyota Motor Corporation,JP,"Toyota City, Japan"`);
}

// ============== CONFIG MODAL ==============
function showConfig() {
  $('corsProxy').value = config.corsProxy;
  $('configModal').classList.remove('hidden');
}

function closeConfig() {
  $('configModal').classList.add('hidden');
}

function saveConfig() {
  config.corsProxy = $('corsProxy').value.trim();
  localStorage.setItem('corsProxy', config.corsProxy);
  cslData = null; // Force reload with new proxy
  closeConfig();
}

$('configModal').onclick = e => { if (e.target.id === 'configModal') closeConfig(); };
</script>
</body>
</html>
